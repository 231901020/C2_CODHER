{% extends "base.html" %}
{% block content %}
<h2>Live Packet Analyser</h2>

<div>
    <button onclick="downloadPcap()">ðŸ“¥ Download .pcap File</button>
</div>

<div id="packet-display" style="margin-top:15px; font-family:monospace; white-space:pre-wrap;"></div>

<canvas id="protocolChart" width="400" height="200" style="margin-top:20px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function loadPackets() {
        fetch('/packet_data')
        .then(response => response.text())
        .then(data => {
            document.getElementById('packet-display').innerHTML = data;
        });
    }

    function downloadPcap() {
        window.location.href = "/download_pcap";
    }

    let chart;
    function createChart(data) {
        const ctx = document.getElementById('protocolChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['TCP', 'UDP', 'ICMP', 'Other'],
                datasets: [{
                    label: 'Protocol Count',
                    data: [data.TCP, data.UDP, data.ICMP, data.Other],
                    backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c']
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function updateChart(data) {
        chart.data.datasets[0].data = [data.TCP, data.UDP, data.ICMP, data.Other];
        chart.update();
    }

    function loadGraph() {
        fetch('/protocol_counts')
        .then(res => res.json())
        .then(data => {
            if (!chart) createChart(data);
            else updateChart(data);
        });
    }

    setInterval(() => {
        loadPackets();
        loadGraph();
    }, 2000);

    loadPackets();
    loadGraph();
</script>
{% endblock %}
